/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Includes ------------------------------------------------------------------------------------------------------------------------------ */
/* ....................................................................................................................................... */

#include "io.h"

/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Defines ------------------------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */

#define IO_CONFIG_GET(CONF, PARAM, MASK)		((CONF >> PARAM) & MASK)

#define IO_MODE_Mask							0x00000003UL
#define IO_MODE_Get(CONF)						IO_CONFIG_GET(CONF, __IO_SHIFT_MODE, IO_MODE_Mask)

#define IO_OUT_TYPE_Mask						0x00000001UL
#define IO_OUT_TYPE_Get(CONF)					IO_CONFIG_GET(CONF, __IO_SHIFT_TYPE_OUT, IO_OUT_TYPE_Mask)

#define IO_SPEED_Mask							0x00000003UL
#define IO_SPEED_Get(CONF)						IO_CONFIG_GET(CONF, __IO_SHIFT_SPEED, IO_SPEED_Mask)

#define IO_PULL_TYPE_Mask						0x00000003UL
#define IO_PULL_TYPE_Get(CONF)					IO_CONFIG_GET(CONF, __IO_SHIFT_PULL_TYPE, IO_PULL_TYPE_Mask)

#define IO_AF_Mask								0x0000000FUL
#define IO_AF_Get(CONF)							IO_CONFIG_GET(CONF, __IO_SHIFT_AF, IO_AF_Mask)

/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Private ------------------------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */

static uint8_t PinToShift(uint16_t PIN);

/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Public Implementation ----------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */

//###################################################################################################################
void xHAL_IO_Init(IO_t io, IO_MODE mode, IO_PULL pull, IO_SPEED speed)
{
	xHAL_IO_Config(io, (IO_Config)(mode | pull | speed));
}

//###################################################################################################################
void xHAL_IO_Config(IO_t IO, IO_Config Config)
{
	if (IO == IO_NO_PIN_PORT)
		return;

	GPIO_TypeDef* GPIOx = IO_PORT(IO);

	uint8_t Shift = PinToShift(IO_PIN(IO));
	uint8_t Shift_X2 = Shift << 1;

	MODIFY_REG(
		GPIOx->MODER,
		IO_MODE_Mask << Shift_X2,
		IO_MODE_Get(Config) << Shift_X2
	);

	MODIFY_REG(
		GPIOx->OTYPER,
		IO_OUT_TYPE_Mask << Shift,
		IO_OUT_TYPE_Get(Config) << Shift
	);

	MODIFY_REG(
		GPIOx->OSPEEDR,
		IO_SPEED_Mask << Shift_X2,
		IO_SPEED_Get(Config) << Shift_X2
	);

	MODIFY_REG(
		GPIOx->PUPDR,
		IO_PULL_TYPE_Mask << Shift_X2,
		IO_PULL_TYPE_Get(Config) << Shift_X2
	);

	uint8_t _AFR = Shift >= 8;
	uint8_t Shift_X4 = (Shift - (_AFR ? 8 : 0)) << 2;

	MODIFY_REG(
		GPIOx->AFR[Shift >= 8],
		IO_AF_Mask << Shift_X4,
		IO_AF_Get(Config) << Shift_X4
	);

	if ((Config & LOCK_PIN) == LOCK_PIN)
		GPIOx->LCKR |= IO_PIN(IO);
}

/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Private Implementation ---------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */

//###################################################################################################################
static uint8_t PinToShift(uint16_t PIN)
{
	uint8_t Shift = 0;

	while (PIN > 1)
	{
		PIN >>= 1;
		Shift++;
	}

	return Shift;
}

/* End ----------------------------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */
