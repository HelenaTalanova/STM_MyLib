/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Includes ------------------------------------------------------------------------------------------------------------------------------ */
/* ....................................................................................................................................... */

#include "custom.h"

/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Defines ------------------------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */

extern void* _estack;
extern void Reset_Handler(void);

bool Setup(void);
bool Loop(void);

/* --------------------------------------------------------------------------------------------------------------------------------------- */
/* Public Implementation ----------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */

IWDG_HandleTypeDef iwdg;

//###################################################################################################################
int main(void)
{
#if !(USE_BOOT || DEBUG)
    xHAL_IWDG_Start();
#elif (USE_BOOT) && (!DEBUG)
    xHAL_IWDG_Refresh();
#endif // !(USE_BOOT) && !(DEBUG)	    

    if (Setup() == false)
    {
        xHAL_hardware_reset();
    }

#if (!DEBUG)
    xHAL_IWDG_Refresh();
#endif // !(DEBUG)  
#if !(USE_BOOT || DEBUG)
    xHAL_FLASH_RDP_Write(X_FLASH_OB_RDP_LEVEL_1);
#endif // !(USE_BOOT)    

    for (;;)
    {
        if (Loop() == false)
            break;

#if (!DEBUG)                
        xHAL_IWDG_Refresh();
        xHAL_sleep();
        xHAL_IWDG_Refresh();
#endif // !(DEBUG)  
    }

    xHAL_hardware_reset();
}

//###################################################################################################################
void xHAL_sleep(void)
{
    SCB->SCR &= ~(SCB_SCR_SLEEPONEXIT_Msk | SCB_SCR_SLEEPDEEP_Msk);
    __WFI();
}

//###################################################################################################################
void xHAL_hardware_reset(void)
{
    __NVIC_SystemReset();
}

//###################################################################################################################
void xHAL_software_reset(void)
{
    extern void* g_pfnVectors[0x30];

    __disable_irq();

    __IO uint32_t sp = (uint32_t)g_pfnVectors[0];

    __set_MSP(sp);
    Reset_Handler();
}

//###################################################################################################################
/**
  * @brief  This function is executed in case of error occurrence.
  * @param  None
  * @retval None
  */
void _Error_Handler(char* file, int line)
{
    for (;;)
    {
    }
}

//###################################################################################################################
/**
  * @brief  This function is executed in case of error occurrence.
  * @param  None
  * @retval None
  */
void _Error_Handler_Message(char* file, int line, const char* message)
{
    for (;;)
    {
    }
}

#ifdef USE_FULL_ASSERT

//###################################################################################################################
/**
   * @brief Reports the name of the source file and the source line number
   * where the assert_param error has occurred.
   * @param file: pointer to the source file name
   * @param line: assert_param error line source number
   * @retval None
   */
void assert_failed(uint8_t* file, uint32_t line)
{
    for (;;)
    {
    }
}

#endif

/* End ----------------------------------------------------------------------------------------------------------------------------------- */
/* ....................................................................................................................................... */